<!DOCTYPE html>
<html>

    <head>

        <meta charset = "utf-8" />
        <title>Nemo - Debugging Results</title>
        <meta name = "viewport" content = "width=device-width, initial-scale=1, shrink-to-fit=no" />
        <link rel = "stylesheet" href = "vendor/bootstrap.min.css" />
        <link rel = "stylesheet" href = "vendor/fontawesome-all.min.css" />
        <link rel = "stylesheet" href = "vendor/nemo.css" />

    </head>

    <body>

        <div class = "container-fluid">

            <h2>Runs</h2>
            <span class = "help-block">Click on a run to see more information.</span>

            <div class = "row">

                <div id = "runs-table"></div>

            </div>

        </div>

        <div id = "summary" class = "container-fluid">

            <h3>Debugging Summary</h3>

            <div class = "row">

                <ul>
                    <li>Item 1</li>
                </ul>

            </div>

        </div>

        <div id = "hazard" class = "container-fluid">

            <h3>Hazard Analysis</h3>
            <span class = "help-block">When do <span style = "color: #b22222;">precondition</span> and <span style = "color: #00bfff;">postcondition</span> hold? If a window exists between pre- and postcondition, this allows for faults.</span>

            <div class = "row">

                <div id = "hazard-analysis"></div>

            </div>

        </div>

        <div id = "pre-post-prov" class = "container-fluid">

            <h3>Pre- and Postcondition Provenance</h3>
            <span class = "help-block">Which events were required for <span style = "color: #b22222;">precondition</span> and <span style = "color: #00bfff;">postcondition</span> to be achieved?</span>
            <span class = "help-block">Message passing events are marked with a <span style = "color: #7cfc00;">bold</span> border, next chains written in <span style = "color: #ffd700;">gold</span>.</span>

            <div class = "row">

                <div class = "col-md">

                    <h4>Pre</h4>

                    <div id = "pre-prov"></div>

                </div>

                <div class = "col-md">

                    <h4>Post</h4>

                    <div id = "post-prov"></div>

                </div>

            </div>

        </div>

        <div id = "cleaned-pre-post-prov" class = "container-fluid">

            <h3>Preprocessed Pre- and Postcondition Provenance</h3>
            <span class = "help-block">Which events were <i>essentially</i> required for <span style = "color: #b22222;">precondition</span> and <span style = "color: #00bfff;">postcondition</span> to be achieved?</span>
            <span class = "help-block">Message passing events are marked with a <span style = "color: #7cfc00;">bold</span> border, next chains written in <span style = "color: #ffd700;">gold</span>.</span>

            <div class = "row">

                <div class = "col-md">

                    <h4>Preprocessed Pre</h4>

                    <div id = "cleaned-pre-prov"></div>

                </div>

                <div class = "col-md">

                    <h4>Preprocessed Post</h4>

                    <div id = "cleaned-post-prov"></div>

                </div>

            </div>

        </div>

        <div id = "prototype-prov" class = "container-fluid">

            <h3>Prototypical Success Provenance</h3>
            <span class = "help-block">What have all successful executions in common?</span>

            <div class = "row">

                <div class = "col-md">

                    <h4>Prototype Pre</h4>

                    <div id = "proto-pre-prov"></div>

                </div>

                <div class = "col-md">

                    <h4>Prototype Post</h4>

                    <div id = "proto-post-prov"></div>

                </div>

            </div>

        </div>

        <div id = "pre-post-correctness" class = "container-fluid">

            <h3>Specification Provenance (Pre <i class = "fas fa-long-arrow-alt-right"></i> Post)</h3>
            <span class = "help-block">Can we suggest modifications to precondition events that make the precondition stricter?</span>

            <ul id = "pre-post-correctness-corrections"></ul>

        </div>

        <div id = "diff-prov" class = "container-fluid">

            <h3>Good - Bad = Differential</h3>
            <span class = "help-block">Which events are missing from the bad execution compared to the good one? Frontier elements are bordered <span style = "color: #c71585;">dashed red</span>.</span>

            <div>

                <h6>Rule &nbsp;<code id = "diff-prov-missing-rule"></code>&nbsp; needs to fire to achieve success, but the following events are not taking place:</h6>
                <ul id = "diff-prov-missing-goals"></ul>

            </div>

            <div class = "row anchor">

                <div class = "diff-prov-checker">

                    <div>
                        <input type = "checkbox" id = "diff-prov-check-good" name = "diff-prov-check-good" value = "good" />
                        <label for = "diff-prov-check-good">Good</label>
                    </div>

                    <div>
                        <input type = "checkbox" id = "diff-prov-check-bad" name = "diff-prov-check-bad" value = "bad" />
                        <label for = "diff-prov-check-bad">Bad</label>
                    </div>

                    <div>
                        <input type = "checkbox" id = "diff-prov-check-diff" name = "diff-prov-check-diff" value = "diff" checked = "checked" />
                        <label for = "diff-prov-check-diff">Difference</label>
                    </div>

                </div>

                <div id = "good-bad-diff-prov"></div>

            </div>

        </div>

    </body>

    <script src = "vendor/d3.min.js"></script>
    <script src = "vendor/jquery.min.js"></script>
    <script src = "vendor/bootstrap.min.js"></script>
    <script type = "text/javascript" charset = "utf-8">

        $(function() {

            var runs = [];
            var selectedRun = null;

            // Hide areas that are only relevant for bad executions.
            d3.select("#diff-prov").style("display", "none");
            d3.select("#pre-post-correctness").style("display", "none");

            $("input[name=diff-prov-check-good]").change(function() {

                if($(this).prop("checked") === true) {
                    d3.select("#good-bad-diff-prov-good").style("display", "block");
                } else {
                    d3.select("#good-bad-diff-prov-good").style("display", "none");
                }
            });

            $("input[name=diff-prov-check-bad]").change(function() {

                if($(this).prop("checked") === true) {
                    d3.select("#good-bad-diff-prov-bad").style("display", "block");
                } else {
                    d3.select("#good-bad-diff-prov-bad").style("display", "none");
                }
            });

            $("input[name=diff-prov-check-diff]").change(function() {

                if($(this).prop("checked") === true) {
                    d3.select("#good-bad-diff-prov-diff").style("display", "block");
                } else {
                    d3.select("#good-bad-diff-prov-diff").style("display", "none");
                }
            });

            var refreshRunsTable = function() {

                var tr = tbody.selectAll("tr").data(runs).enter().append("tr")
                        .on("click", function() {
                            if(selectedRun !== null) {
                                d3.select(selectedRun).classed("active", false);
                            }
                            d3.select(this).classed("active", true);
                            selectedRun = this;
                            displaySelectedRun(d3.select(this).data()[0]);
                        });

                var td = tr.selectAll("td")
                        .data(function(run) {
                            return [
                                run.iteration,
                                formatStatus(run.status),
                                run.failureSpec.crashes.map(formatCrash).join(", "),
                                run.failureSpec.omissions.map(formatMessageLoss).join(", ")
                            ];
                        }).enter().append("td")
                        .html(function(d) {
                            return d;
                        });
            };

            var formatCrash = function(crash) {
                return crash.node + "@" + crash.time;
            };

            var formatMessageLoss = function(loss) {
                return loss.from + " ==> " + loss.to + " @ " + loss.time;
            };

            var formatStatus = function(status) {
                if(status == "success") {
                    return '<span class = "glyphicon glyphicon-ok text-success"> success</span>'
                } else {
                    return '<span class = "glyphicon glyphicon-remove text-danger"> failure</span>'
                }
            };

            var displaySelectedRun = function(newRun) {

                // Hide sections.
                d3.select("#pre-post-correctness").style("display", "none");
                d3.select("#diff-prov").style("display", "none");

                // Remove old figures.
                d3.select("#hazard-analysis img").remove();
                d3.select("#pre-prov img").remove();
                d3.select("#post-prov img").remove();
                d3.select("#cleaned-pre-prov img").remove();
                d3.select("#cleaned-post-prov img").remove();
                d3.select("#proto-pre-prov img").remove();
                d3.select("#proto-post-prov img").remove();

                d3.select("#diff-prov-check-good").property("checked", false);
                d3.select("#diff-prov-check-bad").property("checked", false);
                d3.select("#diff-prov-check-diff").property("checked", true);

                d3.select("#good-bad-diff-prov-good").remove();
                d3.select("#good-bad-diff-prov-bad").remove();
                d3.select("#good-bad-diff-prov-diff").remove();

                d3.select("#diff-prov-missing-rule").html("");
                d3.select("#diff-prov-missing-goals").html("");
                d3.select("#pre-post-correctness-corrections").html("");

                // Add currently selected figures.
                d3.select("#hazard-analysis").append("img").attr("src", "figures/run_" + newRun.iteration + "_spacetime.svg");
                d3.select("#pre-prov").append("img").attr("src", "figures/run_" + newRun.iteration + "_pre_prov.svg");
                d3.select("#post-prov").append("img").attr("src", "figures/run_" + newRun.iteration + "_post_prov.svg");
                d3.select("#cleaned-pre-prov").append("img").attr("src", "figures/run_" + newRun.iteration + "_pre_prov_clean.svg");
                d3.select("#cleaned-post-prov").append("img").attr("src", "figures/run_" + newRun.iteration + "_post_prov_clean.svg");
                d3.select("#proto-pre-prov").append("img").attr("src", "figures/proto_pre.svg");
                d3.select("#proto-post-prov").append("img").attr("src", "figures/proto_post.svg");

                newRun.missingEvents.forEach(function(m) {

                    // TODO: Add multiple 'rules that need to fire' lines.
                    // d3.select("#diff-prov-missing-rule").text(newRun.missingEvents.Rule.label);
                    m.Goals.forEach(function(goal) {
                        d3.select("#diff-prov-missing-goals").append("li").append("code").text(goal.label + " @ " + goal.time);
                    });
                })

                if (typeof newRun.corrections !== 'undefined') {

                    newRun.corrections.forEach(function(corr) {
                        d3.select("#pre-post-correctness-corrections").append("li").html(corr);
                    });
                }

                d3.select("#good-bad-diff-prov").append("img")
                    .attr("src", "figures/run_0_post_prov.svg")
                    .attr("id", "good-bad-diff-prov-good")
                    .attr("class", "low")
                    .style("display", "none");
                d3.select("#good-bad-diff-prov").append("img")
                    .attr("src", "figures/run_" + newRun.iteration + "_diff_post_prov-failed.svg")
                    .attr("id", "good-bad-diff-prov-bad")
                    .attr("class", "medium")
                    .style("display", "none");
                d3.select("#good-bad-diff-prov").append("img")
                    .attr("src", "figures/run_" + newRun.iteration + "_diff_post_prov-diff.svg")
                    .attr("id", "good-bad-diff-prov-diff")
                    .attr("class", "top")
                    .style("display", "block");

                if(newRun.status != "success") {
                    // Make relevant areas visible.
                    d3.select("#diff-prov").style("display", "block");
                    d3.select("#pre-post-correctness").style("display", "block");
                }
            };

            d3.json("debugging.json", function(error, json) {

                var runsTable = d3.select("#runs-table").append("table").attr("class", "table table-sm table-hover");
                thead = runsTable.append("thead").append("tr");
                tbody = runsTable.append("tbody");

                thead.append("th").text("Iteration");
                thead.append("th").text("Status");
                thead.append("th").text("Crashes");
                thead.append("th").text("Message losses");

                json.forEach(function(run) {
                    runs.push(run);
                });

                refreshRunsTable();
            });

        });

    </script>

</html>
